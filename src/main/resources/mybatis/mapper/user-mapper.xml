<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="userInfo">

    <resultMap id="userInfoResult" type="UserInfo">
        <collection property="roles" javaType="ArrayList" column="id" ofType="Role" select="selectRoleForUser"/>
    </resultMap>

    <resultMap id="roleResult" type="Role">
        <collection property="permissions" javaType="ArrayList" column="id" ofType="Permission"
                    select="selectPermissionForRole"/>
    </resultMap>

    <select id="selectPermissionForRole" resultType="Permission">
        SELECT a.* FROM s_permission a LEFT JOIN s_role_permission b ON a.id =b.pid WHERE b.rid = #{id} and a.enable = 1
    </select>

    <select id="selectRoleForUser" resultMap="roleResult">
        SELECT a.* FROM s_role a LEFT JOIN s_user_role b ON a.id =b.`rid` WHERE b.`uid` = #{id} and a.enable = 1
    </select>

    <select id="query" resultMap="userInfoResult">
        select * from s_user
    </select>

    <select id="getUserInfoByPhone" parameterType="string" resultType="UserInfo">
        select * from s_user where phone = #{phone}
    </select>

    <select id="getUserInfoByNumber" parameterType="string" resultType="UserInfo">
        select * from s_user where number = #{number}
    </select>

    <insert id="addUser" parameterType="UserInfo">
        INSERT INTO s_user
            (id,
             number,
             name,
             phone,
             areaId,
             sms,
             statusId,
             idCard,
             bankCard,
             alipayId,
             taobaoId,
             qq,
             writeTime,
             photo1,
             photo2,
             photo3,
             password)
           VALUES (#{id},
        #{number},
        #{name},
        #{phone},
        #{areaId},
        #{sms},
        #{statusId},
        #{idCard},
        #{bankCard},
        #{alipayId},
        #{taobaoId},
        #{qq},
        #{writeTime},
        #{photo1},
        #{photo2},
        #{photo3},
        #{password})
    </insert>

    <update id="editUser" parameterType="UserInfo">
        update s_user
        <set>
            <if test="number != null and number != '' ">
                number=#{number},
            </if>
            <if test="phone != null and phone != '' ">
                phone=#{phone},
            </if>
            <if test="areaId != null and areaId != '' ">
                areaId=#{areaId},
            </if>
            <if test="sms != null and sms != '' ">
                sms=#{sms},
            </if>
            <if test="statusId != null and statusId != '' ">
                statusId=#{statusId},
            </if>
            <if test="idCard != null and idCard != '' ">
                idCard=#{idCard},
            </if>
            <if test="bankCard != null and bankCard != '' ">
                bankCard=#{bankCard},
            </if>
            <if test="alipayId != null and alipayId != '' ">
                alipayId=#{alipayId},
            </if>
            <if test="taobaoId != null and taobaoId != '' ">
                taobaoId=#{taobaoId},
            </if>
            <if test="qq != null and qq != '' ">
                qq=#{qq},
            </if>
            <if test="writeTime != null and writeTime != '' ">
                writeTime=#{writeTime},
            </if>
            <if test="photo1 != null and photo1 != '' ">
                photo1=#{photo1},
            </if>
            <if test="photo2 != null and photo2 != '' ">
                photo2=#{photo2},
            </if>
            <if test="photo3 != null and photo3 != '' ">
                photo3=#{photo3},
            </if>
            <if test="password != null and password != '' ">
                password=#{password},
            </if>
            <if test="tradePassword != null and tradePassword != '' ">
                tradePassword=#{tradePassword},
            </if>
            <if test="oldPhone != null and oldPhone != '' ">
                oldPhone=#{oldPhone},
            </if>
        </set>
        where phone=#{phone}
    </update>

    <update id="disableUser" parameterType="string">
        update  s_user set  statusId=4 where phone=#{phone}
    </update>

</mapper>